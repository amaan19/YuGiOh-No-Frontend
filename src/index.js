deck1 = [
    {
        "id": "549481",
        "name": "Prevent Rat",
        "desc": "This creature is shielded with a tough hide of hair and is excellent at defending itself.",
        "atk": "500",
        "def": "2000",
        "type": "Normal Monster",
        "level": "4",
        "race": "Beast",
        "attribute": "EARTH",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/549481.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/549481.jpg"
    },
    {
        "id": "732302",
        "name": "Temple of Skulls",
        "desc": "A mysterious temple of skulls and bones that pulls in unsuspecting enemies.",
        "atk": "900",
        "def": "1300",
        "type": "Normal Monster",
        "level": "4",
        "race": "Zombie",
        "attribute": "DARK",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/732302.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/732302.jpg"
    },
    {
        "id": "1184620",
        "name": "Kojikocy",
        "desc": "A man-hunter with powerful arms that can crush boulders.",
        "atk": "1500",
        "def": "1200",
        "type": "Normal Monster",
        "level": "4",
        "race": "Warrior",
        "attribute": "EARTH",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/1184620.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/1184620.jpg"
    },
    {
        "id": "1784619",
        "name": "Uraby",
        "desc": "Fast on its feet, this dinosaur rips enemies to shreds with its sharp claws.",
        "atk": "1500",
        "def": "800",
        "type": "Normal Monster",
        "level": "4",
        "race": "Dinosaur",
        "attribute": "EARTH",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/1784619.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/1784619.jpg"
    },
    {
        "id": "2118022",
        "name": "Hyosube",
        "desc": "This amphibian is strong on the attack, but leaves much to be desired when defending.",
        "atk": "1500",
        "def": "900",
        "type": "Normal Monster",
        "level": "4",
        "race": "Aqua",
        "attribute": "WATER",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/2118022.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/2118022.jpg"
    },
    {
        "id": "5053103",
        "name": "Battle Ox",
        "desc": "A monster with tremendous power, it destroys enemies with a swing of its axe.",
        "atk": "1700",
        "def": "1000",
        "type": "Normal Monster",
        "level": "4",
        "race": "Beast-Warrior",
        "attribute": "EARTH",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/5053103.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/5053103.jpg"
    },
    {
        "id": "5265750",
        "name": "Skull Mariner",
        "desc": "A pirate ship that appears out of the mist and sinks any seagoing vessels.",
        "atk": "1600",
        "def": "900",
        "type": "Normal Monster",
        "level": "4",
        "race": "Warrior",
        "attribute": "WATER",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/5265750.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/5265750.jpg"
    }
]

deck2 = [
    {
        "id": "2311603",
        "name": "Overdrive",
        "desc": "An all-terrain armored vehicle armed with a heavy-duty machine gun.",
        "atk": "1600",
        "def": "1500",
        "type": "Normal Monster",
        "level": "4",
        "race": "Machine",
        "attribute": "EARTH",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/2311603.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/2311603.jpg"
    },
    {
        "id": "2483611",
        "name": "Water Omotics",
        "desc": "Transforms the water overflowing from a jar into attacking dragons.",
        "atk": "1400",
        "def": "1200",
        "type": "Normal Monster",
        "level": "4",
        "race": "Aqua",
        "attribute": "WATER",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/2483611.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/2483611.jpg"
    },
    {
        "id": "2863439",
        "name": "Fiend Reflection 2",
        "desc": "A bird-beast that summons reinforcements with a hand mirror.",
        "atk": "1100",
        "def": "1400",
        "type": "Normal Monster",
        "level": "4",
        "race": "Winged Beast",
        "attribute": "LIGHT",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/2863439.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/2863439.jpg"
    },
    {
        "id": "2906250",
        "name": "Grappler",
        "desc": "A devious snake with a thick body that wraps around an enemy monster and squeezes the life out of it.",
        "atk": "1300",
        "def": "1200",
        "type": "Normal Monster",
        "level": "4",
        "race": "Reptile",
        "attribute": "WATER",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/2906250.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/2906250.jpg"
    },
    {
        "id": "3134241",
        "name": "Flying Kamakiri 2",
        "desc": "A flying mantis that feeds primarily on insects.",
        "atk": "1500",
        "def": "800",
        "type": "Normal Monster",
        "level": "4",
        "race": "Insect",
        "attribute": "WIND",
        "image_url": "https://storage.googleapis.com/ygoprodeck.com/pics/3134241.jpg",
        "image_url_small": "https://storage.googleapis.com/ygoprodeck.com/pics_small/3134241.jpg"
    }
]

state = {
    p1: {
        life: null,
        deck: deck1,
        hand: [],
        field: [],
        currentCard: null,
        drawnCard: false,
        turnSummonedMonsters: 0
    },
    p2: {
        life: null,
        deck: deck2,
        hand: [],
        field: [],
        currentCard: null,
        drawnCard: false,
        turnSummonedMonsters: 0
    },
    inplay: []
}

p1 = state.p1
p2 = state.p2


gameStart = () => {
    p1.life = 4000
    p2.life = 4000
}

//DISPLAYING CARDS 

//Hand
var handEl = document.querySelector('#my-hand')

//My Helper functions

addToHandState = card => {
    p1.hand.push(card)
}

addToFieldState = card => {
    p1.field.push(card)
    state.inplay.push(card)
}

removeFromHand = card => {
    p1.hand = p1.hand.filter(c => c !== card)
    renderHandCards(p1.hand)
}

removeFromFieldState = card => {
    p1.field = p1.field.filter(c => c !== card)
}

startingHand = () => {
    for (let i = 0; i < 3; i++) {
        card = p1.deck.pop()
        renderHandCard(card)
        addToHandState(card)
    }
}

renderHandCard = card => {
    cardImg = document.createElement('img')
    cardImg.src = card.image_url
    cardImg.id = card.id
    handEl.appendChild(cardImg)
}

renderHandCards = cards => {
    handCards.innerHTML = ''
    cards.forEach(card => {
        renderHandCard(card)
    })
}

findCard = id => {
    return card = p1.hand.find(c => c.id === id)
}

renderFieldMonsters = cards => {
    fieldEl.innerHTML = ''
    cards.forEach(c => renderFieldMonster(c))
}

//Opponent helper functions 
removeFromOppFieldState = card => {
    p2.field = p2.field.filter(c => c !== card)
}

const oppFieldEl = document.querySelector('.opp-field')

renderOppFieldMonster = card => {
    cardImg = document.createElement('img')
    cardImg.src = card.image_url
    cardImg.id = card.id
    oppFieldEl.appendChild(cardImg)
    p2.field.push(card)
}

renderOppFieldMonsters = cards => {
    oppFieldEl.innerHTML = ''
    cards.forEach(c => renderOppFieldMonster(c))
}


//Attacking 
attackVattack = (myMonster, oppMonster) => {
    difference = myMonster.atk - oppMonster.atk
    if (difference > 0) {
        destroyOppMonster(oppMonster)
        p2.life -= difference
        renderOppFieldMonsters(p2.field)
    } else if (difference < 0) {
        destroyMyMonster(myMonster)
        p1.life += difference
    } else {
    }
}
const fieldEl = document.querySelector('.my-monsters')

fieldEl.addEventListener('click', e => {
    if (e.target.nodeName === "IMG") {
        myCard = p1.field.find(c => c.id === e.target.id)

        oppFieldEl.addEventListener('click', ev => {
            if (ev.target.nodeName === "IMG") {
                oppCard = p2.field.find(c => c.id === ev.target.id)
                attackVattack(myCard, oppCard)
            }
        })
    }

})

//Destroying monster 
destroyMyMonster = card => {
    removeFromFieldState(card)
    renderFieldMonsters(p1.field)
}

destroyOppMonster = card => {
    removeFromOppFieldState(card)
    renderOppFieldMonsters(p2.field)
}

//Draw card 
const deck = document.querySelector('#my-deck')

drawCard = () => {
    if (!p1.drawnCard) {
        card = p1.deck.pop()
        addToHandState(card)
        renderHandCard(card)
        p1.drawnCard = true
    } else {
        alert("You've already drawn a card this turn")
    }

}
deck.addEventListener('click', () => {
    drawCard()
})


//Play card 



renderFieldMonster = card => {
    cardImg = document.createElement('img')
    cardImg.src = card.image_url
    cardImg.id = card.id
    fieldEl.appendChild(cardImg)
}

playCard = card => {
    if (p1.turnSummonedMonsters < 2) {
        renderFieldMonster(card)
        addToFieldState(card)
        removeFromHand(card)
        renderHandCards(p1.hand)
        p1.turnSummonedMonsters += 1
    } else {
        alert("You've already summoned 2 monsters this turn")
    }

}

const handCards = document.querySelector('#my-hand')

handCards.addEventListener('click', e => {
    car = p1.hand.find(card => card.id == e.target.id)
    playCard(car)
})


let gamestate = []

function getGame(id) {
    fetch(`http://localhost:3000/api/v1/games/${id}`).then(function (response) { return response.json() }).then(game => getGameState(game))
}

function getGameState(game) { gamestate = game.gamestate }

let currentCard = null

function getCard(card_id) {
    fetch(`http://localhost:3000/api/v1/cards/${card_id}`).then(function (response) { return response.json() }).then(card => currentCard = card)
}


function updateGameState() {
    fetch(`http://localhost:3000/api/v1/games/${gamestate.game_id}`, {
        method: 'PUT',
        body: JSON.stringify(gamestate),
        headers: {
            'Content-Type': 'application/json'
        },
    }).then(res => res.json())
        .then(response => console.log('Success:', JSON.stringify(response)))
        .catch(error => console.error('Error:', error));
}

function getMyDeck() {
    fetch(`http://localhost:3000/api/v1/decks/${gamestate.p1deckid}`).then(function (response) { return response.json() }).then(deck => loadDeck(deck, "me"))
}

function getOppDeck() {
    fetch(`http://localhost:3000/api/v1/decks/${gamestate.p2deckid}`).then(function (response) { return response.json() }).then(deck => loadDeck(deck, "opp"))
}

function loadDeck(deck, player) {
    if (player === "me") {
        deck1 = deck.cards
    } else {
        deck2 = deck.cards
    }
}
